{% extends 'base.html' %}
{% block content %}

<h2 class="text-2xl font-bold mb-6">Dashboard Administrador</h2>

<!-- Panel principal de métricas -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
  <!-- Usuarios -->
  <div class="bg-white p-6 shadow rounded">
    <h3 class="text-lg font-bold mb-4">👤 Usuarios Registrados</h3>
    <div class="overflow-x-auto">
      <table class="min-w-full text-sm divide-y divide-gray-200">
        <thead class="bg-gray-100">
          <tr>
            <th class="px-4 py-2 text-left font-semibold text-gray-700">Nombre</th>
            <th class="px-4 py-2 text-left font-semibold text-gray-700">Rol</th>
            <th class="px-4 py-2 text-left font-semibold text-gray-700">Correo</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-gray-100">
          {% for user in users %}
          <tr class="hover:bg-gray-50">
            <td class="px-4 py-2">{{ user.name }}</td>
            <td class="px-4 py-2 capitalize">{{ user.role }}</td>
            <td class="px-4 py-2">{{ user.email }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- Proyectos -->
  <div class="bg-white p-6 shadow rounded">
    <h3 class="text-lg font-bold mb-4">📊 Proyectos Totales</h3>
    <div class="overflow-x-auto">
      <table class="min-w-full text-sm divide-y divide-gray-200">
        <thead class="bg-gray-100">
          <tr>
            <th class="px-4 py-2 font-semibold text-gray-700">Nombre</th>
            <th class="px-4 py-2 font-semibold text-gray-700">Progreso</th>
            <th class="px-4 py-2 font-semibold text-gray-700">Inicio</th>
            <th class="px-4 py-2 font-semibold text-gray-700">Fin</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-gray-100">
          {% for project in projects %}
          <tr class="hover:bg-gray-50">
            <td class="px-4 py-2">{{ project.name }}</td>
            <td class="px-4 py-2">{{ project.progress }}%</td>
            <td class="px-4 py-2">{{ project.start_date }}</td>
            <td class="px-4 py-2">{{ project.end_date }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Detalle de proyectos -->
<div class="mt-10">
  <h3 class="text-xl font-bold mb-4">📁 Proyectos Detallados</h3>

  {% set color_map = {
      'activo': 'bg-green-100 text-green-800 border-green-300',
      'suspendido': 'bg-red-100 text-red-800 border-red-300',
      'finalizado': 'bg-blue-100 text-blue-800 border-blue-300',
      'en espera': 'bg-yellow-100 text-yellow-800 border-yellow-300'
  } %}

  {% for project in projects %}
  <div class="bg-white border border-gray-200 shadow rounded-xl p-6 mb-8">
    <div class="flex justify-between items-center mb-4">
      <div>
        <h4 class="text-lg font-bold text-corporativo-morado">{{ project.name }}</h4>
        <p class="text-sm text-gray-500">📅 {{ project.start_date }} → {{ project.end_date }}</p>
        <p class="text-sm mt-1 text-gray-600">Progreso: {{ project.progress }}%</p>
        <div class="w-full bg-gray-200 h-2 rounded mt-1 mb-2">
          <div class="bg-corporativo-naranjo h-2 rounded transition-all duration-500" style="width: {{ project.progress }}%;"></div>
        </div>
      </div>
      <span class="px-3 py-1 text-xs font-semibold rounded-full border {{ color_map[project.status] }}">{{ project.status }}</span>
    </div>

    {% if project.admin_comment %}
    <div class="text-sm text-yellow-800 bg-yellow-50 border-l-4 border-yellow-400 p-3 rounded mb-4">
      <strong>Comentario del Administrador:</strong> {{ project.admin_comment }}
    </div>
    {% endif %}

    <!-- Botones de acción -->
    <div class="flex flex-wrap gap-2 mb-4">
      <a href="{{ url_for('ver_bitacora', project_id=project.id) }}" class="text-xs bg-corporativo-morado text-white px-3 py-1.5 rounded hover:bg-corporativo-naranjo transition">📚 Bitácora</a>
      <a href="{{ url_for('project_tasks', project_id=project.id) }}" class="text-xs bg-green-600 text-white px-3 py-1.5 rounded hover:bg-green-700 transition">✅ Ver Tareas</a>
    </div>

    <!-- Tabla de tareas -->
    <table class="w-full text-sm divide-y divide-gray-200 border border-gray-200 rounded">
      <thead class="bg-gray-100 text-left text-xs font-semibold text-gray-700">
        <tr>
          <th class="px-4 py-2">Tarea</th>
          <th class="px-4 py-2">Descripción</th>
          <th class="px-4 py-2">Asignado a</th>
          <th class="px-4 py-2">Estado</th>
          <th class="px-4 py-2">Fecha Límite</th>
        </tr>
      </thead>
      <tbody class="divide-y divide-gray-100">
        {% for task in tasks_by_project[project.id] %}
        <tr>
          <td class="px-4 py-2 font-medium">{{ task.name }}</td>
          <td class="px-4 py-2">{{ task.description or '—' }}</td>
          <td class="px-4 py-2">{{ task.assigned_to.name if task.assigned_to else '—' }}</td>
          <td class="px-4 py-2 capitalize">{{ task.status }}</td>
          <td class="px-4 py-2">{{ task.due_date.strftime('%d/%m/%Y') if task.due_date else '—' }}</td>
        </tr>
        {% else %}
        <tr>
          <td colspan="5" class="text-center text-gray-400 py-4">No hay tareas registradas para este proyecto</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% endfor %}
</div>

<!-- Botón métricas -->
<div class="text-center mt-8">
  <a href="{{ url_for('admin_metrics') }}"
     class="bg-corporativo-morado hover:bg-corporativo-naranjo text-white px-6 py-2 rounded shadow inline-block transition">
    📈 Ver Métricas del Sistema
  </a>
</div>

{% endblock %}
